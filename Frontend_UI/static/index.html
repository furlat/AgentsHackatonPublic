<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>HK3 Parquet Lab</title>
	<style>
		:root{--bg:#0b0f14;--fg:#c9d1d9;--muted:#7d8590;--accent:#00ffc6;--accent2:#7aa2f7;--glass:rgba(255,255,255,0.06);--border:rgba(255,255,255,0.08)}
		*{box-sizing:border-box}
		html,body{height:100%}
		body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:14px}
		#app{display:flex;flex-direction:column;min-height:100vh}
		.topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0));backdrop-filter:saturate(120%) blur(6px);position:sticky;top:0;z-index:10}
		.brand{font-weight:700;letter-spacing:.5px;color:var(--accent)}
		.actions{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
		.chip{background:transparent;color:var(--fg);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
		.chip:hover{border-color:var(--accent);color:var(--accent)}
		.layout{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:auto auto 1fr;gap:16px;padding:16px}
		.panel{border:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));border-radius:10px;padding:12px;position:relative;overflow:hidden}
		.panel h2{margin:0 0 8px 0;color:var(--accent2);font-size:14px}
		.schema textarea{width:100%;min-height:140px;background:#0a0f14;color:var(--fg);border:1px dashed var(--border);border-radius:6px;padding:8px}
		.row{display:flex;gap:12px;align-items:center;margin-top:8px}
		.muted{color:var(--muted);font-size:12px}
		.btn{background:transparent;color:var(--accent);border:1px solid var(--accent);padding:6px 10px;border-radius:6px}
		.btn:hover{background:var(--accent);color:#001f1a}
		.drop-zone{display:flex;align-items:center;justify-content:center;min-height:120px;border:1px dashed var(--border);border-radius:8px;color:var(--muted)}
		.controls{display:grid;grid-template-columns:auto 1fr;gap:6px;align-items:center;margin-bottom:8px}
		.columns{display:flex;flex-wrap:wrap;gap:6px}
		.col-chip{padding:4px 8px;border:1px solid var(--border);border-radius:6px}
		.input{background:#0a0f14;color:var(--fg);border:1px dashed var(--border);border-radius:6px;padding:6px}
		.table-container{max-height:340px;overflow:auto;border:1px solid var(--border);border-radius:6px}
        table{width:100%;border-collapse:collapse;font-size:12px}
        th,td{border-bottom:1px solid var(--border);padding:6px 8px}
        th{white-space:nowrap}
        td{vertical-align:top}
        .cell{position:relative}
        .cell-content{display:-webkit-box;-webkit-line-clamp:2;line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;white-space:normal;word-break:break-word}
        .cell-content.expanded{-webkit-line-clamp:unset;line-clamp:unset;max-height:none;overflow:visible}
        .cell-ellipsis{position:absolute;right:6px;bottom:4px;background:transparent;color:var(--muted);border:1px solid var(--border);border-radius:4px;padding:0 6px;line-height:16px;height:18px;font-size:12px;cursor:pointer}
        .cell-ellipsis:hover{color:var(--accent);border-color:var(--accent)}
		th{position:sticky;top:0;background:#0a0f14;color:var(--accent2);z-index:1}
		.terminal{background:#000;min-height:140px;max-height:calc(1.2em * 15);line-height:1.2em;border-radius:6px;border:1px solid #111;color:#33ff88;padding:8px;overflow:auto}
		.glass{box-shadow:0 8px 30px rgba(0,0,0,0.35);backdrop-filter:blur(10px)}
		#graphPanel{height:800px;display:flex;flex-direction:column;overflow:hidden;grid-column:1 / -1}
		#graphPlot{width:100%;flex:1 1 auto;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));border:1px dashed var(--border);border-radius:6px;display:block;height:auto;min-height:0;contain:paint}
		.helper{font-size:12px;color:var(--muted);margin-top:6px}
		.file-title{margin-top:6px;color:var(--accent2);font-weight:700}
		.footer-fade{position:fixed;left:0;right:0;bottom:0;height:12px;max-height:12px;background:linear-gradient(180deg, rgba(11,15,20,0), rgba(11,15,20,0.85));pointer-events:none;z-index:20}
		@media (max-width:1000px){.layout{grid-template-columns:1fr;grid-template-rows:auto}}
	</style>
</head>
<body>
	<div id="app">
		<header class="topbar">
			<div class="brand">HK3 ▓▒░ Parquet Lab</div>
		</header>

        <main class="layout">
            <section class="panel schema">
                <h2>Schema (Pydantic-compatible)</h2>
                <textarea id="schemaInput" placeholder="class MySchema(BaseModel):
    text: str
    doc_id: str
    created_at: datetime"></textarea>
                <div class="row">
                    <button class="btn" id="saveSchema">Save Schema</button>
                    <span class="muted" id="schemaStatus"></span>
                </div>
				<div class="row">
					<label class="muted">Template</label>
					<select id="schemaTemplateSelect" class="input">
						<option value="narrative_full">NarrativeAnalysis (with Action)</option>
						<option value="action_only">Action (only)</option>
					</select>
					<button class="btn" id="insertSchemaTemplate">Insert Template</button>
					<button class="btn" id="clearSchema">Clear</button>
				</div>
            </section>

            <section class="panel dnd">
                <h2>Drop Parquet</h2>
                <div id="dropZone" class="drop-zone">Drag & Drop .parquet here</div>
                <input id="fileInput" type="file" accept=".parquet" style="display:none" />
				<div class="file-title" id="fileTitle"></div>
                <div class="helper" id="fileMeta"></div>
            </section>

            <section class="panel preview">
				<h2>Preview</h2>
				<div class="controls">
					<label>Columns</label>
                    <div class="columns" id="columns">
						<span class="col-chip">col_a</span>
						<span class="col-chip">col_b</span>
						<span class="col-chip">col_c</span>
					</div>
					<label>Filters</label>
                    <input id="filters" class="input" placeholder="e.g., score > 0.5 and lang == 'en'" />
				</div>
                <div class="table-container" id="tableContainer">
					<table>
						<thead>
							<tr><th>col_a</th><th>col_b</th><th>col_c</th></tr>
						</thead>
						<tbody>
							<tr><td>1</td><td>x</td><td>alpha</td></tr>
							<tr><td>2</td><td>y</td><td>beta</td></tr>
							<tr><td>3</td><td>z</td><td>gamma</td></tr>
						</tbody>
					</table>
				</div>
				<div class="helper">Static preview rows for layout only</div>
			</section>

			<section class="panel console glass" id="consolePanel">
				<h2>Process Parquet</h2>
				<div class="row">
					<button class="btn" id="modalExtractSchema" title="Send schema to Modal (vLLM) to extract schema">Extract Schema</button>
					<button class="btn" id="modalGenerateEmbeddings" title="Generate embeddings on Modal (vLLM)">Generate Embeddings</button>
				</div>
                <pre class="terminal" id="console">Ready.</pre>
			</section>

			<section class="panel" id="graphPanel">
				<h2>Narrative Graph</h2>
				<div class="row">
					<button class="btn" id="scanModalBtn" title="Scan Modal processed volume for files">Scan Modal Volume</button>
					<span class="muted" id="scanStatus"></span>
				</div>
				<nav class="actions">
					<button class="chip" id="dragRotate" title="Rotate view (orbit)">Rotate</button>
					<button class="chip" id="dragZoom" title="Zoom/pan view">Zoom</button>
				</nav>
				<nav class="actions" id="modalFiles"></nav>
				<div class="row" id="simpleRow">
					<button class="btn" id="buildGraphBtn" title="Build interactions graph">Build Graph</button>
					<button class="btn" id="buildCharsBtn" title="Build character↔character graph">Characters Only</button>
					<button class="btn" id="cleanViewBtn" title="Split and beautify names">Clean View</button>
					<button class="btn" id="storyBtn" title="Build progressively row by row">Story Mode</button>
					<button class="btn" id="stopBtn" title="Stop story mode">Stop</button>
					<input type="number" id="rowsInput" class="input" value="200" min="10" max="500" step="10" style="width:90px" />
					<span class="muted" id="simpleInfo"></span>
				</div>
				<nav class="actions">
					<button class="chip" data-category="actions" title="Extract actions">Actions</button>
					<button class="chip" data-category="characters" title="Extract characters">Characters</button>
					<button class="chip" data-category="situation" title="Extract situation">Situation</button>
					<button class="chip" data-category="consequences" title="Extract consequences">Consequences</button>
					<button class="chip" data-category="outcome" title="Extract outcome">Outcome</button>
				</nav>
				<div id="graphPlot" aria-label="Graph placeholder"></div>
				<div class="helper">3D graph renders with Plotly</div>
			</section>
		</main>
    </div>
		<div class="footer-fade" aria-hidden="true"></div>
	<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="/static/main.js"></script>
</body>
</html>


